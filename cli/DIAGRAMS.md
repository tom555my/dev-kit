# dev-kit CLI Architecture Diagrams

This document provides visual representations of the CLI architecture, data flow, and interactions.

## Module Dependency Graph

```
┌─────────────────────────────────────────────────────────────┐
│                        cli.ts (Entry)                       │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ Core Router  │   │   Commands   │   │ Config Mgr   │
└──────────────┘   └──────────────┘   └──────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                            ▼
                ┌──────────────────────┐
                │   Agent Registry     │
                └──────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│  Resource    │   │   Installer  │   │   Agents     │
│   Manager    │   │              │   │              │
└──────────────┘   └──────────────┘   └──────────────┘
```

## Command Flow: dev-kit init claude-code

```
┌─────────┐     ┌─────────┐     ┌─────────────┐     ┌───────────┐
│  User   │────>│   CLI   │────>│   Config    │────>│   Load    │
└─────────┘     └─────────┘     └─────────────┘     └───────────┘
                                                  │
                                                  ▼
                                            ┌───────────┐
                                            │ Registry  │
                                            └───────────┘
                                                  │
                      ┌───────────────────────────┘
                      │
                      ▼
              ┌───────────────┐
              │ Detect Agent  │
              └───────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ▼                           ▼
┌───────────────┐          ┌───────────────┐
│   Found?      │          │   Not Found   │
└───────────────┘          └───────────────┘
        │                           │
        ▼                           ▼
┌───────────────┐          ┌───────────────┐
│ Get Resources │          │    Error      │
└───────────────┘          └───────────────┘
        │
        ▼
┌───────────────┐
│  Install      │
│  All Skills   │
└───────────────┘
        │
        ▼
┌───────────────┐
│  Verify       │
└───────────────┘
        │
        ▼
┌───────────────┐
│  Success      │
└───────────────┘
```

## Skill Installation Flow

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   Agent      │────>│  Installer   │────>│  Validator   │
└──────────────┘     └──────────────┘     └──────────────┘
                                                 │
                              ┌──────────────────┤
                              │                  │
                              ▼                  ▼
                        ┌──────────┐      ┌──────────┐
                        │  Valid?  │      │ Invalid? │
                        └──────────┘      └──────────┘
                              │                  │
                              ▼                  ▼
                        ┌──────────┐      ┌──────────┐
                        │ Backup   │      │  Error   │
                        └──────────┘      └──────────┘
                              │
                              ▼
                        ┌──────────┐
                        │  Copy    │
                        │  Files   │
                        └──────────┘
                              │
                              ▼
                        ┌──────────┐
                        │ Verify  │
                        └──────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
          ┌──────────┐                ┌──────────┐
          │ Success  │                │  Error   │
          └──────────┘                └──────────┘
                │                           │
                ▼                           ▼
          ┌──────────┐                ┌──────────┐
          │ Cleanup  │                │ Rollback │
          │ Backup   │                │          │
          └──────────┘                └──────────┘
```

## Error Handling Flow

```
┌──────────────┐
│  Exception  │
└──────┬───────┘
       │
       ▼
┌──────────────────┐
│ Error Classifier │
└──────┬───────────┘
       │
  ┌────┴────┬─────────┬──────────┐
  │         │         │          │
  ▼         ▼         ▼          ▼
┌──────┐ ┌──────┐ ┌──────┐  ┌──────┐
│ User │ │System│ │Valid │  │ Other│
└──┬───┘ └──┬───┘ └──┬───┘  └───┬──┘
   │         │         │          │
   ▼         ▼         ▼          ▼
┌─────────┐ ┌───────┐ ┌───────┐ ┌─────────┐
│Show     │ │Log +  │ │List   │ │Unknown │
│Message  │ │Show   │ │Issues │ │Error    │
│+Suggest │ │Error  │ │       │ │         │
└─────────┘ └───────┘ └───────┘ └─────────┘
```

## Resource Embedding Flow

```
Build Time:                      Runtime:
┌──────────┐                   ┌──────────┐
│  Source  │                   │   CLI    │
│  Skills  │                   │ Binary   │
└────┬─────┘                   └────┬─────┘
     │                              │
     ▼                              ▼
┌──────────┐                   ┌──────────┐
│  Embed   │                   │  Access  │
│  Script  │                   │  Assets  │
└────┬─────┘                   └────┬─────┘
     │                              │
     ▼                              ▼
┌──────────┐                   ┌──────────┐
│  Read    │                   │  Serve   │
│  Files   │                   │  Content │
└────┬─────┘                   └────┬─────┘
     │                              │
     ▼                              ▼
┌──────────┐                   ┌──────────┐
│  Write   │                   │  Return  │
│ to       │                   │  to User │
│  Binary  │                   └──────────┘
└──────────┘
```

## Config Loading and Migration

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│  Start  │────>│  Load   │────>│  Exists │
└─────────┘     └─────────┘     └────┬────┘
                                      │
                         ┌────────────┴────────────┐
                         │                         │
                         ▼                         ▼
                   ┌──────────┐              ┌──────────┐
                   │    Yes   │              │    No   │
                   └────┬─────┘              └────┬─────┘
                        │                         │
                        ▼                         ▼
                  ┌──────────┐              ┌──────────┐
                  │  Parse   │              │ Create   │
                  │  JSON    │              │ Default  │
                  └────┬─────┘              └────┬─────┘
                       │                         │
                       ▼                         │
                 ┌──────────┐                    │
                 │ Check    │                    │
                 │ Version  │                    │
                 └────┬─────┘                    │
                      │                         │
           ┌──────────┴──────────┐              │
           │                     │              │
           ▼                     ▼              │
     ┌──────────┐          ┌──────────┐         │
     │ Current  │          │  Old     │         │
     └────┬─────┘          └────┬─────┘         │
          │                     │               │
          └──────────┬──────────┘               │
                     ▼                          │
              ┌──────────┐                      │
              │ Migrate  │                      │
              └────┬─────┘                      │
                   │                            │
                   └──────────────┬─────────────┘
                                  ▼
                           ┌──────────┐
                           │ Validate │
                           └────┬─────┘
                                │
                   ┌────────────┴────────────┐
                   │                         │
                   ▼                         ▼
             ┌──────────┐              ┌──────────┐
             │  Valid   │              │ Invalid │
             └────┬─────┘              └────┬─────┘
                  │                         │
                  ▼                         ▼
            ┌──────────┐              ┌──────────┐
            │  Return  │              │  Error   │
            └──────────┘              └──────────┘
```

## Multi-Agent Detection Flow

```
┌──────────┐
│  Start   │
└────┬─────┘
     │
     ▼
┌──────────────────┐
│ For Each Agent   │◄────────┐
│  in Registry     │         │
└────┬─────────────┘         │
     │                      │
     ▼                      │
┌──────────────────┐         │
│  Check SkillPath │         │
└────┬─────────────┘         │
     │                      │
     ▼                      │
┌──────────────────┐         │
│  Directory       │         │
│  Exists?         │         │
└────┬─────────────┘         │
     │                      │
  ┌──┴──┐                   │
  │     │                   │
  ▼     ▼                   │
┌───┐ ┌───┐                 │
│Yes│ │No │                 │
└─┬─┘ └─┬─┘                 │
  │     │                   │
  ▼     ▼                   │
┌──────┐ ┌──────┐           │
│Mark  │ │Mark  │           │
│Detected│ │Not   │           │
└──────┘ │Found │           │
         └──────┘           │
              │             │
              └─────────────┘
                    │
                    ▼
            ┌──────────────┐
            │ Return All   │
            │ Detected     │
            └──────────────┘
```

## Build Pipeline

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│  Source  │────>│  Embed   │────>│ Type     │
│  Code    │     │ Resources│     │ Check    │
└──────────┘     └──────────┘     └────┬─────┘
                                        │
                                        ▼
                                  ┌──────────┐
                                  │ Compile  │
                                  │ (Bun)    │
                                  └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │ Optimize │
                                  │ (Minify) │
                                  └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │ Sign     │
                                  │ (Code)   │
                                  └────┬─────┘
                                       │
                                       ▼
                                  ┌──────────┐
                                  │ Package  │
                                  │ (Release)│
                                  └──────────┘
```

## File System Layout

```
~/
├── .claude/
│   └── skills/                    ← Claude Code skills
│       ├── dev-kit-init/
│       ├── dev-kit-ticket/
│       └── ...
├── .copilot-skills/               ← GitHub Copilot skills
│   ├── dev-kit-init/
│   ├── dev-kit-ticket/
│   └── ...
├── .cursor/                       ← Cursor extensions
│   └── extensions/
│       └── dev-kit-skills-1.0.0.vsix
└── .dev-kit/                      ← CLI config
    └── config.json                ← User preferences
```

## Data Flow: Onboarding Command

```
┌─────────┐     ┌─────────┐     ┌──────────────┐
│  User   │────>│   CLI   │────>│ Command:     │
│  runs  │     │  Parse  │     │ onboard       │
└─────────┘     └─────────┘     └──────┬───────┘
                                      │
                                      ▼
                             ┌──────────────┐
                             │ Resource     │
                             │ Manager      │
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │ Get          │
                             │ ONBOARDING.md│
                             └──────┬───────┘
                                    │
                                    ▼
                             ┌──────────────┐
                             │ Format       │
                             │ (Terminal/   │
                             │  Markdown)   │
                             └──────┬───────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
            ┌──────────────┐               ┌──────────────┐
            │ Display to   │               │ Write to     │
            │ Terminal     │               │ File         │
            └──────────────┘               └──────────────┘
```

## Testing Pyramid

```
                    ┌──────────┐
                    │   E2E    │  ← Complete workflows
                    │  Tests   │    (5% of tests)
                    └────┬─────┘
                         │
                ┌────────┴────────┐
                │                 │
         ┌──────┴──────┐   ┌──────┴──────┐
         │Integration  │   │  Property   │
         │   Tests     │   │   Tests     │  (15% of tests)
         └──────┬──────┘   └──────┬──────┘
                │                 │
                └────────┬────────┘
                         │
                ┌────────┴────────┐
                │                 │
         ┌──────┴──────┐   ┌──────┴──────┐
         │   Unit      │   │  Benchmark  │
         │   Tests     │   │    Tests    │  (80% of tests)
         └─────────────┘   └─────────────┘
```

## State Machine: Installation

```
┌─────────┐
│  Start  │
└────┬────┘
     │
     ▼
┌─────────┐
│Detecting│
└────┬────┘
     │
     ▼
┌─────────┐    ┌─────────┐
│  Found  │───>│  Error  │
└────┬────┘    └────┬────┘
     │              │
     ▼              │
┌─────────┐          │
│Validating│         │
└────┬────┘          │
     │              │
     ▼              │
┌─────────┐    ┌─────┴─────┐
│  Valid  │───>│   Error   │
└────┬────┘    └───────────┘
     │
     ▼
┌─────────┐
│Backing Up│
└────┬────┘
     │
     ▼
┌─────────┐    ┌─────────┐
│Success  │───>│  Error  │
└────┬────┘    └────┬────┘
     │              │
     ▼              │
┌─────────┐          │
│Installing│        │
└────┬────┘          │
     │              │
     ▼              │
┌─────────┐    ┌─────┴─────┐
│Success  │───>│   Error   │
└────┬────┘    │  (Rollback)│
     │        └───────────┘
     ▼
┌─────────┐
│Verifying│
└────┬────┘
     │
     ▼
┌─────────┐    ┌─────────┐
│Success  │───>│  Error  │
└────┬────┘    │(Rollback)│
     │        └────┬─────┘
     ▼             │
┌─────────┐         │
│Complete │         │
└─────────┘         │
              ┌─────┴─────┐
              │  Rollback │
              └───────────┘
```

## Component Communication Pattern

```
┌─────────────────────────────────────────────────────────────┐
│                        CLI Interface                        │
│                     (Commander.js)                          │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌────────────┐   ┌────────────┐   ┌────────────┐
│   Command  │   │   Command  │   │   Command  │
│ Handlers   │   │ Handlers   │   │ Handlers   │
└─────┬──────┘   └─────┬──────┘   └─────┬──────┘
      │                │                │
      └────────────┬───┴────────────────┘
                   │
                   ▼
         ┌─────────────────┐
         │  Shared State   │
         │  (Config, etc.) │
         └─────────────────┘
                   │
         ┌─────────┴─────────┐
         │                   │
         ▼                   ▼
┌────────────┐        ┌────────────┐
│    Agent   │        │  Resource  │
│   Registry │        │  Manager   │
└─────┬──────┘        └─────┬──────┘
      │                     │
      └──────────┬──────────┘
                 │
                 ▼
         ┌──────────────┐
         │  File System │
         └──────────────┘
```

## Extension Points

```
┌──────────────────────────────────────────────────────────┐
│                      dev-kit CLI                          │
└──────────────────────────────────────────────────────────┘
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
┌────────────┐   ┌────────────┐   ┌────────────┐
│   New      │   │   New      │   │   New      │
│  Agent     │   │  Command   │   │  Skill     │
└────────────┘   └────────────┘   └────────────┘

1. New Agent:
   - Implement Agent interface
   - Register in AgentRegistry
   - Add to supported agents

2. New Command:
   - Implement CommandHandler
   - Register in CLI router
   - Add help text

3. New Skill:
   - Add to .claude/skills/
   - Embed in build
   - Rebuild binary
```
